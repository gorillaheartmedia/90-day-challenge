<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>90-Day 5-Goal Desktop Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<style>
  body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(115deg, #e7f7fd 0%, #d4e6fc 100%);
  min-height: 100vh;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}
.container {
  max-width: 980px;
  margin: 30px auto 30px auto;
  background: rgba(255,255,255,0.91);
  border-radius: 30px;
  box-shadow: 0 10px 36px 0 rgba(54,86,120,0.10), 0 2px 4px 0 rgba(74,124,170,0.06);
  padding: 28px 20px 28px 20px;
  box-sizing: border-box;
}
h1 {
  text-align: center;
  font-size: 2.25em;
  font-weight: 800;
  margin-bottom: 4px;
  background: linear-gradient(90deg,#319cfa 10%,#6ffab6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-fill-color: transparent;
  filter: drop-shadow(0 2px 4px #319cfa16);
  width: 100%;
}
.settings-bar {
  text-align: right;
  margin-bottom: 12px;
  padding-right: 16px;
}
.settings-btn {
  background: linear-gradient(90deg,#d7eaf6 60%,#c6f7e6 100%);
  border: 1.7px solid #6bdad9;
  color: #2995d1;
  border-radius: 12px;
  padding: 7px 18px;
  font-size: 1.08em;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  box-shadow: 0 1.5px 7px #57e9e344;
  margin-bottom: 2px;
}
.settings-btn:hover {
  background: #31e5a533;
  color: #17825b;
  border-color: #37b599;
}
.progress-section {
  text-align: center;
  margin-bottom: 24px;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.progress-bar-bg {
  width: 72%;
  background: rgba(220,234,250,0.68);
  border-radius: 19px;
  height: 28px;
  margin: 0 auto 12px auto;
  box-shadow: 0 1.5px 6px 0 rgba(49,180,250,0.12);
  overflow: hidden;
  border: 1.5px solid #b9e3fa7a;
  position: relative;
  max-width: 410px;
}
.progress-bar {
  background: linear-gradient(90deg, #41e1a8 2%, #319cfa 96%);
  height: 28px;
  border-radius: 19px;
  width: 0%;
  box-shadow: 0 2px 14px #41e1a850 inset;
  transition: width 0.9s cubic-bezier(0.31,0.67,0.49,1.13);
}
.percentage, .small-note, #challenge-dates {
  text-align: center !important;
  width: 100%;
  display: block;
  margin: 0 auto 6px auto;
}
.percentage {
  font-size: 1.21em;
  font-weight: 700;
  color: #145f8d;
  text-shadow: 0 1px 2px #b0e7f6cc;
  margin-bottom: 8px;
}
/* --- Intervention Wizard Modal --- */
#intervene-modal-card {
  max-width: 420px;
  width: 98vw;
}

#intervene-content {
  text-align: left;
}

.intervene-step-label {
  font-weight: 700;
  color: #249da7;
  margin-bottom: 5px;
  margin-top: 13px;
  display: block;
}

.intervene-input, .intervene-textarea {
  width: 97%;
  border-radius: 7px;
  padding: 8px 7px;
  font-size: 1.06em;
  border: 1.6px solid #b8e0e9;
  background: #f9fcfd;
  margin-bottom: 10px;
  font-family: inherit;
  transition: border-color 0.12s;
}
.intervene-input:focus, .intervene-textarea:focus {
  outline: none;
  border-color: #39e7d2;
  background: #f6fcfa;
}
.intervene-actions {
  margin-top: 18px;
  text-align: center;
}
.intervene-actions button {
  background: linear-gradient(90deg,#ffb85b 20%,#fa6872 100%);
  color: #fff;
  border: none;
  border-radius: 9px;
  padding: 7px 22px;
  font-size: 1.07em;
  font-weight: 700;
  margin: 0 7px;
  box-shadow: 0 1.5px 9px #faa57c3c;
  cursor: pointer;
  transition: background 0.14s;
}
.intervene-actions button:hover {
  background: linear-gradient(90deg,#fa6872 15%,#ffb85b 100%);
}

/* --- Exclamation mark for red stoplight --- */
.stoplight-exclaim {
  display: inline-block;
  margin-left: 6px;
  font-size: 1.44em;
  color: #f85438;
  cursor: pointer;
  vertical-align: middle;
  font-weight: 900;
  transition: color 0.18s, transform 0.13s;
}
.stoplight-exclaim:hover {
  color: #ff8b3d;
  transform: scale(1.13) rotate(-10deg);
}

/* --- Show a sticky note for active intervention --- */
.stoplight-intervention-note {
  display: inline-block;
  background: #fffbe3;
  color: #df9000;
  border-radius: 7px;
  padding: 2.5px 8px;
  font-size: 0.94em;
  margin-top: 6px;
  margin-bottom: 2px;
  box-shadow: 0 2px 8px #efd66445;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.01em;
}
.info-btn {
  background: linear-gradient(90deg,#5eebae 10%,#36a7ee 100%);
  color: #fff;
  border: none;
  border-radius: 14px;
  padding: 10px 30px;
  font-size: 1.13em;
  font-weight: 700;
  cursor: pointer;
  margin: 0 auto 18px auto;
  display: block;
  box-shadow: 0 2px 12px #a7f0e840;
  transition: background 0.13s, transform 0.1s;
}
.info-btn:active { background: #22c39c; transform: scale(0.98);}
.table-wrap {
  width: 100%;
  overflow-x: auto;
}
table {
  border-collapse: separate;
  border-spacing: 0 6px;
  width: 100%;
  background: none;
  margin-bottom: 13px;
  font-size: 1.06em;
  box-shadow: none;
  table-layout: fixed;
  min-width: 880px;
  position: relative;
}
th, td {
  border: none;
  padding: 8px 4px;
  text-align: center;
  background: rgba(255,255,255,0.78);
  border-radius: 11px;
  box-shadow: 0 2.5px 10px #bbd2ea20;
  font-weight: 500;
  vertical-align: middle;
  position: relative;
}
th {
  background: linear-gradient(90deg,#e5f7fd 50%,#e8fff5 100%);
  font-size: 1.04em;
  font-weight: 700;
  color: #269fc9;
  letter-spacing: 0.01em;
  box-shadow: 0 1.5px 4px #b5dffc24;
  z-index: 2;
}
tr {
  transition: background 0.19s;
}
tr:hover td {
  background: #f0f9ffb3 !important;
}
.goal-btn {
  background: linear-gradient(90deg, #f5fafd 70%, #e4f6f6 100%);
  border: 2.2px solid #b5c2d1;
  color: #3791d1;
  padding: 7px 15px;
  border-radius: 10px;
  font-size: 1.03em;
  font-weight: 500;
  cursor: pointer;
  outline: none;
  transition: 
    background 0.19s,
    border-color 0.19s,
    color 0.15s,
    box-shadow 0.2s,
    transform 0.16s;
  box-shadow: 0 2px 10px #60d0fb1a;
  min-width: 90px;
  max-width: 100px;
}
.goal-btn:active { 
  background: #dafce8;
  transform: scale(0.93);
}
.goal-btn.completed {
  background: linear-gradient(90deg, #49dfa0 15%, #31b7fa 100%);
  color: #fff;
  border: 2.2px solid #30a987;
  font-weight: 700;
  box-shadow: 0 2px 16px #31b7fa34 inset;
  transform: scale(1.08);
  letter-spacing: 0.01em;
  filter: drop-shadow(0 1.8px 6px #36deac60);
}
.star {
  color: #ffd700;
  font-size: 1.38em;
  margin-left: 7px;
  filter: drop-shadow(0 2px 4px #f7d73d6a);
  animation: shine 0.7s;
}
@keyframes shine {
  0% { transform: scale(0.7) rotate(-18deg);}
  62% { transform: scale(1.25) rotate(10deg);}
  90% { filter: drop-shadow(0 2px 15px #ffe670);}
  100% { transform: scale(1) rotate(0);}
}
.perfect-day {
  color: #ffd700;
  font-size: 1.35em;
  font-weight: 800;
  display: inline-block;
  margin-left: 6px;
  vertical-align: middle;
  animation: pop 0.7s cubic-bezier(.22,1.01,.69,.95);
  text-shadow: 0 2px 10px #ffef8598;
  filter: drop-shadow(0 1.5px 9px #ffd70095);
}
@keyframes pop {
  0% { transform: scale(0.7);}
  70% { transform: scale(1.35);}
  100% { transform: scale(1);}
}
.small-note {
  color: #708497;
  font-size: 0.99em;
  margin-top: 14px;
  text-align: center;
  opacity: 0.88;
  letter-spacing: 0.01em;
  padding-bottom: 2px;
}
tr.today-row td {
  border: 2.5px solid #68e7b8 !important;
  background: #f7fffab3 !important;
  font-weight: 700;
  box-shadow: 0 1.5px 11px #68e7b81c;
}
/* --- Stoplight Row Above Table --- */
.stoplight-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 34px;
  margin: 13px 0 17px 0;
  flex-wrap: wrap;
}
.stoplight-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 110px;
  flex: 1 1 120px;
}
.stoplight-label {
  font-size: 1em;
  font-weight: 600;
  color: #269fc9;
  margin-bottom: 6px;
  text-align: center;
}
.goal-stoplight {
  display: inline-block;
  width: 1.7em;
  height: 1.7em;
  border-radius: 50%;
  background: #eee;
  box-shadow: 0 1.5px 7px #a7f0e84a;
  border: 2.5px solid #fff;
  position: relative;
  margin-bottom: 4px;
}
.stoplight-green { background: #3ece5a; border-color: #acebb4; }
.stoplight-yellow { background: #f5d21f; border-color: #f7eab0; }
.stoplight-red { background: #eb5454; border-color: #ffd2d2; }
.stoplight-status-label {
  font-size: 0.97em;
  color: #888;
  margin-top: 2px;
  text-align: center;
}
.goal-title-link {
  cursor: pointer;
  text-decoration: underline dotted #3791d1 1.5px;
  color: #2486b9;
  font-weight: 700;
  transition: color 0.12s;
}
.goal-title-link:hover { color: #20be7c; }
.daily-note-row td {
  background: #eafaff !important;
  border: none !important;
  padding: 7px 4px 11px 4px !important;
  box-shadow: 0 1.5px 8px #67e4f114;
}
.daily-note {
  width: 95%;
  min-height: 24px;
  border-radius: 8px;
  border: 1.2px solid #aee7f8;
  background: #fff;
  font-size: 1em;
  padding: 6px 7px;
  margin: 2px auto;
  box-shadow: 0 1.5px 7px #c7eaff14;
  font-family: inherit;
  resize: vertical;
}
.daily-note:focus { outline: none; border-color: #25d4af; background: #f4fef8;}
/* --- Modal, Wizard, and Chart (no change) --- */
.modal-bg {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(60,100,170,0.14);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  overflow-y: auto; /* Add this */
  padding: 20px 0; /* Add space for safe bottom */
}
.modal-bg.active { display: flex; }
.modal-card {
  background: #fff;
  border-radius: 22px;
  box-shadow: 0 10px 42px #39b7fa2b, 0 3px 10px #aae9d728;
  padding: 35px 25px 28px 25px;
  width: 410px;
  max-width: 92vw;
  max-height: 95vh; /* Force modal to stay within screen height */
  overflow-y: auto; /* Allow modal itself to scroll */
  position: relative;
  animation: pop .32s cubic-bezier(.22,1.01,.69,.95);
}
#perfect-days-modal-card { max-width: 710px; width: 99vw;}
.close-modal {
  position: absolute;
  right: 22px;
  top: 16px;
  font-size: 1.6em;
  color: #49dfa0;
  cursor: pointer;
  font-weight: 800;
  border: none;
  background: none;
  outline: none;
  transition: color 0.13s;
  z-index: 101;
}
.close-modal:hover { color: #eb5656; }
.wizard-step { margin-bottom: 16px; }
.wizard-progress {
  color: #319cfa; font-size: 0.97em; font-weight: 700;
  margin-bottom: 10px;
  letter-spacing: 0.01em;
}
.wizard-actions {
  margin-top: 16px;
  text-align: center;
}
.wizard-actions button {
  background: linear-gradient(90deg,#5eebae 30%,#36a7ee 100%);
  color: #fff; border: none; border-radius: 9px;
  padding: 7px 23px; font-size: 1.1em; font-weight: 700;
  margin: 0 7px; box-shadow: 0 1.5px 10px #54dfd44e;
  cursor: pointer; transition: background 0.14s;
}
.wizard-actions button:hover {
  background: linear-gradient(90deg,#36a7ee 10%,#5eebae 100%);
}
.wizard-input, .wizard-textarea, .wizard-date {
  width: 99%; border-radius: 7px; padding: 8px 6px;
  font-size: 1.06em; border: 1.6px solid #b8e0e9;
  background: #f9fcfd; margin-bottom: 2px; font-family: inherit;
  transition: border-color 0.12s;
}
.wizard-textarea { min-height: 34px; }
.wizard-input:focus, .wizard-textarea:focus, .wizard-date:focus {
  outline: none; border-color: #39e7d2; background: #f6fcfa;
}
.wizard-summary {
  background: #f5fafc;
  border-radius: 14px;
  padding: 13px 8px;
  margin-bottom: 13px;
  font-size: 1.05em;
  color: #27809c;
  box-shadow: 0 1px 9px #b9f6ed33;
  text-align: left;
}
.wizard-summary b { color: #249da7; }
/* --- Sticky table head --- */
thead th {
  position: sticky;
  top: 0;
  z-index: 5;
}
/* --- Perfect Day Grid Squares --- */
.perfect-day-table {
  border-collapse: separate;
  border-spacing: 2px 6px;
  margin: 0 auto 10px auto;
  width: auto;
}
.perfect-day-table th, .perfect-day-table td {
  text-align: center;
  padding: 5px 4px;
  background: none;
  border: none;
}
.perfect-square {
  display: inline-block;
  width: 24px; height: 24px;
  border-radius: 7px;
  background: #e6e6e6;
  opacity: 0.34;
  transition: background 0.2s, opacity 0.15s;
  cursor: pointer;
  border: 1.1px solid #b6e1e8;
  position: relative;
  margin: 0 1.5px;
}
.perfect-square.filled {
  background: linear-gradient(90deg, #41e1a8 30%, #319cfa 96%);
  opacity: 1;
  border: 1.3px solid #36b7fa;
  box-shadow: 0 2px 10px #3ae9f421;
}
.perfect-square:hover:after {
  content: attr(data-date);
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  background: #319cfa;
  color: #fff;
  padding: 2px 7px;
  font-size: 0.89em;
  border-radius: 7px;
  white-space: nowrap;
  z-index: 22;
  opacity: 1;
  pointer-events: none;
}
.perfect-day-table th {
  font-weight: bold;
  color: #269fc9;
  font-size: 1.06em;
  letter-spacing: 0.01em;
}
/* Responsive tweaks */
@media (max-width: 1150px) {
  .container { max-width: 99vw; }
  .progress-bar-bg { width: 98%; }
  table { min-width: 700px; font-size: 0.98em;}
}
@media (max-width: 850px) {
  th, td { font-size: 0.94em; padding: 5px 1.5px;}
  .goal-btn { font-size: 0.94em; padding: 6px 8px;}
  table { min-width: 570px; }
}
@media (max-width: 700px) {
  .container { padding: 8px 0.5vw;}
  h1 { font-size: 1.25em;}
  .progress-bar-bg { height: 22px; }
  table { font-size: 0.90em; min-width: 430px;}
  .stoplight-row { gap: 10px; }
}
@media (max-width: 520px) {
  .container { padding: 1px 0vw;}
  h1 { font-size: 1em; }
  .progress-bar-bg { height: 17px; }
  table { font-size: 0.84em; min-width: 350px;}
  .goal-btn { min-width: 40px; max-width: 64px; font-size: 0.80em; padding: 5px 2px; }
}
@media (max-width: 520px) {
  .modal-card {
    max-height: 90vh;
    overflow-y: auto;
    padding-bottom: 20px !important;
  }
}


</style>
<body>
  <div class="container">
<div class="settings-bar" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; padding-right: 16px;">
  <button class="settings-btn" id="open-wizard-btn">New Challenge / Edit Goals</button>
  <button class="settings-btn" id="review-interventions-btn">Review Interventions</button>
</div>

    
    <h1 id="challenge-title">90-Day 5-Goal Daily Tracker</h1>
    <div class="progress-section">
      <div class="progress-bar-bg">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <span class="percentage" id="percent"></span>
      <div class="small-note" id="challenge-dates"></div>
    </div>
    <button class="info-btn" id="show-perfect-days-btn">Show Perfect Day Grid</button>
    <div id="stoplight-row" class="stoplight-row"></div>
    <div class="modal-bg" id="intervene-modal-bg">
  <div class="modal-card" id="intervene-modal-card">
    <button class="close-modal" id="close-intervene-modal">&times;</button>
    <div id="intervene-content"></div>
  </div>
</div>
    <div class="table-wrap">
      <table id="tracker-table">
        <thead>
          <tr id="tracker-header-row">
            <th>Date</th>
            <th><span class="goal-title-link" data-goal-id="0">WALK/JOG</span></th>
            <th><span class="goal-title-link" data-goal-id="1">MEDICATION</span></th>
            <th><span class="goal-title-link" data-goal-id="2">STRENGTH TRAINING</span></th>
            <th><span class="goal-title-link" data-goal-id="3">HOUSE CLEANING</span></th>
            <th><span class="goal-title-link" data-goal-id="4">WEBSITE PROJECTS</span></th>
            <th>Perfect Day?</th>
          </tr>
        </thead>
        <tbody id="tracker-body"></tbody>
      </table>
    </div>
    <div class="small-note">
      ⭐ Click each button to complete a goal. Progress is saved in your browser.<br>
      <b>Tip:</b> Bookmark this page for quick access every day!
    </div>
  </div>

  <!-- Sounds -->
  <audio id="success-sound" src="success.mp3" preload="auto"></audio>
  <audio id="perfect-sound" src="perfect.mp3" preload="auto"></audio>

  <!-- Goal Info Modal -->
  <div class="modal-bg" id="goal-modal-bg">
    <div class="modal-card" id="goal-modal-card">
      <button class="close-modal" id="close-goal-modal">&times;</button>
      <h2 id="goal-modal-title"></h2>
      <p id="goal-modal-desc"></p>
    </div>
  </div>

  <!-- Perfect Day Grid Modal -->
  <div class="modal-bg" id="perfect-days-modal-bg">
    <div class="modal-card" id="perfect-days-modal-card" style="max-width:710px">
      <button class="close-modal" id="close-perfect-days-modal">&times;</button>
      <h2 style="margin-bottom:12px;">Perfect Day Tracker (by Weekday)</h2>
      <div id="perfect-days-grid" style="overflow-x:auto;min-width:310px;"></div>
      <div class="small-note">Colored squares = all goals completed on that weekday</div>
    </div>
  </div>

  <!-- Step-by-step Wizard Modal -->
  <div class="modal-bg" id="wizard-modal-bg">
    <div class="modal-card" id="wizard-modal-card">
      <button class="close-modal" id="close-wizard-modal">&times;</button>
      <div id="wizard-content"></div>
    </div>
  </div>

  <!-- Interventions Review Modal -->
<div class="modal-bg" id="intervention-review-modal-bg">
  <div class="modal-card" id="intervention-review-modal-card">
    <button class="close-modal" id="close-intervention-review-modal">&times;</button>
    <h2 style="margin-bottom: 12px;">Active Interventions</h2>
    <div id="intervention-review-content" style="text-align:left;"></div>
  </div>
</div>


  <script>
// ========================
// 90-Day 5-Goal Tracker - Desktop Table UI
// ========================

// --------- CONFIGURATION AND STORAGE ----------
const DEFAULTS = {
  challengeTitle: "90-Day 5-Goal Daily Tracker",
  startDate: new Date().toISOString().slice(0,10),
  goals: [
    "Complete walk/jog",
    "Take medication",
    "Weight lifting & pushups",
    "Laundry/trash/floor care",
    "1hr video editing/voice acting/programming"
  ],
  goalDescs: [
    "Complete your daily walk or jog. The goal is to build endurance and get closer to your 1hr 15min walking/jogging target.",
    "Take any daily medications or supplements as prescribed. Prioritize your health routines.",
    "Do your weight lifting and pushup routine for the day. Build strength and stay active.",
    "Take care of laundry, trash, and floors. A clean environment supports a clear mind.",
    "Work for 1 hour on video editing, voice acting, or programming. Progress adds up!"
  ]
};
const STORAGE_KEY = "my_90day_goal_tracker_desktop_v1";

function getSavedData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; }
}
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function getChallengeConfig() {
  const data = getSavedData();
  if (!data.challenge) {
    return {...DEFAULTS, days: 90};
  }
  return {...data.challenge, days: 90};
}
function saveChallengeConfig(config) {
  let data = getSavedData();
  data.challenge = config;
  saveData(data);
}

function genDates(startDate, days) {
  let arr = [];
  let d = new Date(startDate + "T00:00:00");
  for(let i=0; i<days; i++) {
    let nd = new Date(d);
    nd.setDate(d.getDate() + i);
    arr.push(nd);
  }
  return arr;
}

// --------- INTERVENTIONS STORAGE ----------
function getInterventions() {
  let data = getSavedData();
  return data.interventions || {};
}
function saveIntervention(goalIndex, intervention) {
  let data = getSavedData();
  data.interventions = data.interventions || {};
  data.interventions[goalIndex] = intervention;
  saveData(data);
}
function clearIntervention(goalIndex) {
  let data = getSavedData();
  if (data.interventions && data.interventions[goalIndex]) {
    delete data.interventions[goalIndex];
    saveData(data);
  }
}

// --------- RENDER TABLE ----------
function renderTable() {
  const config = getChallengeConfig();
  const {goals, goalDescs, startDate, days} = config;
  let data = getSavedData();
  data.progress = data.progress || {};
  data.notes = data.notes || {};
  data.perfectPlayed = data.perfectPlayed || {};
  let tbody = document.getElementById('tracker-body');
  tbody.innerHTML = '';
  let allDates = genDates(startDate, days);
  let total = 0, completed = 0;
  let todayStr = (new Date()).toLocaleDateString('en-US', {month:'2-digit',day:'2-digit',year:'numeric'});
  allDates.forEach((dateObj, row) => {
    let dateStr = dateObj.toLocaleDateString('en-US', {month:'2-digit',day:'2-digit',year:'numeric'});
    let dayName = dateObj.toLocaleDateString('en-US', {weekday:'short'});
    let tr = document.createElement('tr');
    if (dateStr === todayStr) tr.classList.add('today-row');
    let tdDate = document.createElement('td');
    tdDate.innerHTML = `<b>${dayName}</b> <br>${dateStr}`;
    tr.appendChild(tdDate);

    let perfect = true;
    for(let col=0; col<goals.length; col++) {
      total++;
      let cellId = `${row}_${col}`;
      let done = data.progress[cellId] === true;
      let td = document.createElement('td');
      let btn = document.createElement('button');
      btn.className = 'goal-btn' + (done ? ' completed' : '');
      btn.textContent = done ? 'Done' : 'Mark Done';
      btn.onclick = () => {
        let nowDone = !done;
        data.progress[cellId] = nowDone;
        saveData(data);
        if (nowDone) playSound();
        // Check for perfect day sound
        let allDone = true;
        for (let cc=0; cc<goals.length; cc++) {
          if (cc === col) {
            if (!nowDone) allDone = false;
          } else {
            if (!(data.progress[`${row}_${cc}`] === true)) allDone = false;
          }
        }
        if (allDone && !data.perfectPlayed[row]) {
          playPerfectSound();
          data.perfectPlayed[row] = true;
          saveData(data);
        }
        if (!allDone && data.perfectPlayed[row]) {
          data.perfectPlayed[row] = false;
          saveData(data);
        }
        renderTable();
        renderStoplights();
      };
      td.appendChild(btn);
      if (done) {
        let star = document.createElement('span');
        star.className = 'star';
        star.textContent = '⭐';
        td.appendChild(star);
        completed++;
      } else {
        perfect = false;
      }
      tr.appendChild(td);
    }
    let tdPerfect = document.createElement('td');
    if (perfect) {
      tdPerfect.innerHTML = `<span class="perfect-day">🌟</span> <span style="color:#389e6c;font-size:1.03em;font-weight:700;">Perfect!</span>`;
    }
    tr.appendChild(tdPerfect);
    tbody.appendChild(tr);

    // Add note row under each day
    let noteTr = document.createElement('tr');
    noteTr.className = "daily-note-row";
    let noteTd = document.createElement('td');
    noteTd.colSpan = 7;
    let noteKey = `note_${row}`;
    noteTd.innerHTML = `
      <textarea class="daily-note" id="note-${row}" placeholder="Add a note for this day...">${data.notes[noteKey]||""}</textarea>
    `;
    noteTr.appendChild(noteTd);
    tbody.appendChild(noteTr);

    // Save on blur (or change) of the note
    setTimeout(() => {
      let noteBox = document.getElementById(`note-${row}`);
      if (noteBox) {
        noteBox.onchange = function() {
          data.notes[noteKey] = this.value;
          saveData(data);
        }
      }
    }, 5);
  });

  let percent = Math.round((completed/total)*1000)/10;
  document.getElementById('percent').textContent = `${completed} / ${total} (${percent}%) completed`;
  document.getElementById('progress-bar').style.width = `${percent}%`;

  // Challenge info at top
  document.getElementById('challenge-title').textContent = config.challengeTitle || DEFAULTS.challengeTitle;
  let endDate = allDates[allDates.length-1];
  let prettyStart = allDates[0].toLocaleDateString('en-US', {month:'short', day:'2-digit', year:'numeric'});
  let prettyEnd = endDate.toLocaleDateString('en-US', {month:'short', day:'2-digit', year:'numeric'});
  document.getElementById('challenge-dates').textContent = `From ${prettyStart} to ${prettyEnd} (${days} days) • Goal: 80%+ completion`;
}

// --------- STOPLIGHT BY REGULARITY (STREAK) with Intervention! ----------
function getGoalRegularityStatus(goalIndex) {
  const config = getChallengeConfig();
  const { startDate, days } = config;
  let data = getSavedData();
  data.progress = data.progress || {};
  let allDates = genDates(startDate, days);

  // Go from today backward, count how many consecutive days were "missed"
  let today = new Date();
  let missStreak = 0;
  for (let i = allDates.length - 1; i >= 0; i--) {
    let dateObj = allDates[i];
    if (dateObj > today) continue; // Skip future days
    let cellId = `${i}_${goalIndex}`;
    let completed = data.progress[cellId] === true;
    if (completed) break; // Streak broken (was completed)
    else missStreak++;
  }
  // Status logic:
  if (missStreak === 0) return "green";
  if (missStreak === 1) return "yellow";
  return "red";
}

function renderStoplights() {
  const config = getChallengeConfig();
  const {goals} = config;
  const stoplightRow = document.getElementById('stoplight-row');
  const interventions = getInterventions();
  stoplightRow.innerHTML = '';
  for (let col = 0; col < goals.length; col++) {
    let status = getGoalRegularityStatus(col);
    let stoplightClass = 'stoplight-red';
    let statusLabel = 'Needs Attention!';
    if (status === "green") { stoplightClass = 'stoplight-green'; statusLabel = "Consistent!"; }
    else if (status === "yellow") { stoplightClass = 'stoplight-yellow'; statusLabel = "Just Missed"; }
    // Block for each goal
    let block = document.createElement('div');
    block.className = 'stoplight-block';
    let label = document.createElement('div');
    label.className = 'stoplight-label';
    label.innerHTML = `<span>${goals[col]}</span>`;
    let light = document.createElement('span');
    light.className = 'goal-stoplight ' + stoplightClass;
    light.title = statusLabel;
    block.appendChild(label);
    block.appendChild(light);
    // Show exclamation if red, click to intervene
    if (status === "red") {
      let ex = document.createElement('span');
      ex.className = 'stoplight-exclaim';
      ex.textContent = '!';
      ex.title = "Trouble with this goal? Click for help.";
      ex.onclick = () => openInterveneWizard(col);
      block.appendChild(ex);

      // Show sticky note for active intervention
      if (interventions[col]) {
        let note = document.createElement('div');
        note.className = 'stoplight-intervention-note';
        note.innerHTML = `<span>📝 ${interventions[col].reminder || "You planned an intervention"}</span>`;
        block.appendChild(note);
      }
    }
    let statusText = document.createElement('div');
    statusText.className = 'stoplight-status-label';
    statusText.textContent = statusLabel;
    block.appendChild(statusText);
    stoplightRow.appendChild(block);
  }
  // Optional: Auto-clear interventions if goal no longer red
  for (let col = 0; col < goals.length; col++) {
    let status = getGoalRegularityStatus(col);
    let interventions = getInterventions();
    if ((status === "green" || status === "yellow") && interventions[col]) {
      clearIntervention(col);
    }
  }
}

// --------- PERFECT DAY GRID MODAL ----------
function renderPerfectDaysGrid() {
  const config = getChallengeConfig();
  const {startDate, days} = config;
  let data = getSavedData();
  data.perfectPlayed = data.perfectPlayed || {};
  let allDates = genDates(startDate, days);

  // Build map: { "Mon": [rowIndex, ...], ... }
  let weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  let weekdayMap = {};
  weekdays.forEach(wd => weekdayMap[wd]=[]);
  allDates.forEach((dateObj, row) => {
    let dayName = dateObj.toLocaleDateString('en-US', {weekday:'short'});
    // Normalize to 'Mon' format
    dayName = dayName.slice(0,3);
    // Safari/iOS uses different capitalization!
    let wdIdx = weekdays.findIndex(w => w.toLowerCase() === dayName.toLowerCase());
    if (wdIdx > -1) weekdayMap[weekdays[wdIdx]].push({row, date: dateObj});
  });

  // Find the max length (some weekdays will have 13, some 12)
  let maxLen = Math.max(...Object.values(weekdayMap).map(arr=>arr.length));

  // Build HTML table
  let html = `<table class="perfect-day-table"><thead><tr><th>Weekday</th>`;
  for(let i=1;i<=maxLen;i++) html+=`<th>#${i}</th>`;
  html+=`</tr></thead><tbody>`;
  weekdays.forEach(wd => {
    html += `<tr><th>${wd}</th>`;
    let arr = weekdayMap[wd];
    for(let i=0;i<maxLen;i++) {
      if (arr[i]) {
        let {row, date} = arr[i];
        let dateStr = date.toLocaleDateString('en-US', {month:'2-digit',day:'2-digit',year:'numeric'});
        let filled = data.perfectPlayed[row] ? "filled" : "";
        html += `<td>
          <span class="perfect-square ${filled}" data-date="${dateStr}" title="${dateStr}"></span>
        </td>`;
      } else {
        html += `<td></td>`;
      }
    }
    html += `</tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('perfect-days-grid').innerHTML = html;
}

// Modal open/close logic for perfect day grid
document.getElementById('show-perfect-days-btn').onclick = function() {
  document.getElementById('perfect-days-modal-bg').classList.add('active');
  setTimeout(renderPerfectDaysGrid, 5);
};
document.getElementById('close-perfect-days-modal').onclick = function() {
  document.getElementById('perfect-days-modal-bg').classList.remove('active');
};
document.getElementById('perfect-days-modal-bg').onclick = function(e) {
  if (e.target === this) document.getElementById('perfect-days-modal-bg').classList.remove('active');
};

// --- SOUND ---
function playSound() {
  let audio = document.getElementById('success-sound');
  if (audio) { audio.currentTime = 0; audio.play(); }
}
function playPerfectSound() {
  let audio = document.getElementById('perfect-sound');
  if (audio) { audio.currentTime = 0; audio.play(); }
}

// ---------- GOAL MODAL ----------
function openGoalModal(goalId) {
  const config = getChallengeConfig();
  document.getElementById('goal-modal-title').textContent = config.goals[goalId];
  document.getElementById('goal-modal-desc').textContent = config.goalDescs[goalId];
  document.getElementById('goal-modal-bg').classList.add('active');
}
function closeGoalModal() {
  document.getElementById('goal-modal-bg').classList.remove('active');
}

// ---------- INTERVENTION WIZARD ----------
let interveneGoalIndex = null;
let interveneStep = 0;
let interveneData = {};

function openInterveneWizard(goalIndex) {
  interveneGoalIndex = goalIndex;
  interveneStep = 0;
  interveneData = { obstacle:"", change:"", action:"", reminder:"" };
  renderInterveneStep();
  document.getElementById('intervene-modal-bg').classList.add('active');
}
function closeInterveneWizard() {
  document.getElementById('intervene-modal-bg').classList.remove('active');
}
function renderInterveneStep() {
  const config = getChallengeConfig();
  const goalName = config.goals[interveneGoalIndex] || "";
  let content = document.getElementById('intervene-content');
  let step = interveneStep;
  let html = '';
  // Step indicator
  html += `<div class="wizard-progress">Step ${step+1} of 4</div>`;
  if (step === 0) {
    html += `
      <div class="intervene-step-label">What is the main obstacle to completing <b>${goalName}</b>?</div>
      <input class="intervene-input" id="intervene-obstacle" type="text" placeholder="E.g. too tired, forgetful, etc." value="${interveneData.obstacle||""}">
      <div class="intervene-actions">
        <button id="interveneNext">Next</button>
      </div>
    `;
    content.innerHTML = html;
    document.getElementById('interveneNext').onclick = () => {
      interveneData.obstacle = document.getElementById('intervene-obstacle').value.trim();
      interveneStep++;
      renderInterveneStep();
    };
  } else if (step === 1) {
    html += `
      <div class="intervene-step-label">What could you change to help you achieve this goal?</div>
      <input class="intervene-input" id="intervene-change" type="text" placeholder="E.g. set a reminder, ask for support..." value="${interveneData.change||""}">
      <div class="intervene-actions">
        <button id="intervenePrev">Back</button>
        <button id="interveneNext">Next</button>
      </div>
    `;
    content.innerHTML = html;
    document.getElementById('intervenePrev').onclick = () => { interveneStep--; renderInterveneStep(); };
    document.getElementById('interveneNext').onclick = () => {
      interveneData.change = document.getElementById('intervene-change').value.trim();
      interveneStep++;
      renderInterveneStep();
    };
  } else if (step === 2) {
    html += `
      <div class="intervene-step-label">What is one specific action you will try next?</div>
      <textarea class="intervene-textarea" id="intervene-action" placeholder="Describe your action...">${interveneData.action||""}</textarea>
      <div class="intervene-actions">
        <button id="intervenePrev">Back</button>
        <button id="interveneNext">Next</button>
      </div>
    `;
    content.innerHTML = html;
    document.getElementById('intervenePrev').onclick = () => { interveneStep--; renderInterveneStep(); };
    document.getElementById('interveneNext').onclick = () => {
      interveneData.action = document.getElementById('intervene-action').value.trim();
      interveneStep++;
      renderInterveneStep();
    };
  } else if (step === 3) {
    html += `
      <div class="intervene-step-label">Encouragement or reminder to your future self (optional):</div>
      <textarea class="intervene-textarea" id="intervene-reminder" placeholder="Write a reminder or encouragement...">${interveneData.reminder||""}</textarea>
      <div class="intervene-actions">
        <button id="intervenePrev">Back</button>
        <button id="interveneFinish">Finish & Save</button>
      </div>
    `;
    content.innerHTML = html;
    document.getElementById('intervenePrev').onclick = () => { interveneStep--; renderInterveneStep(); };
    document.getElementById('interveneFinish').onclick = () => {
      interveneData.reminder = document.getElementById('intervene-reminder').value.trim();
      saveIntervention(interveneGoalIndex, interveneData);
      closeInterveneWizard();
      renderStoplights();
    };
  }
}

// Dismiss modal logic
document.getElementById('close-intervene-modal').onclick = closeInterveneWizard;
document.getElementById('intervene-modal-bg').onclick = function(e) {
  if (e.target === this) closeInterveneWizard();
};
window.addEventListener('keydown', function(e) {
  if (e.key === "Escape") closeInterveneWizard();
});

document.getElementById('review-interventions-btn').onclick = function () {
  const interventions = getInterventions();
  const config = getChallengeConfig();
  const container = document.getElementById('intervention-review-content');
  container.innerHTML = '';

  let count = 0;
  for (let goalId in interventions) {
    const intv = interventions[goalId];
    const goalTitle = config.goals[goalId] || `Goal ${parseInt(goalId)+1}`;
    count++;
    container.innerHTML += `
      <div style="margin-bottom: 16px; padding: 12px; background:#f9fdfc; border-left: 4px solid #38cfa7; border-radius: 8px; box-shadow: 0 2px 8px #aaf8e330;">
        <div style="font-weight: 700; color: #2b9fb6; margin-bottom: 6px;">${goalTitle}</div>
        <div><b>Obstacle:</b> ${intv.obstacle || '—'}</div>
        <div><b>Change:</b> ${intv.change || '—'}</div>
        <div><b>Action:</b> ${intv.action || '—'}</div>
        <div><b>Reminder:</b> ${intv.reminder || '—'}</div>
      </div>
    `;
  }

  if (count === 0) {
    container.innerHTML = `<p style="color:#888;">No active interventions at this time.</p>`;
  }

  document.getElementById('intervention-review-modal-bg').classList.add('active');
};

document.getElementById('close-intervention-review-modal').onclick = function () {
  document.getElementById('intervention-review-modal-bg').classList.remove('active');
};
document.getElementById('intervention-review-modal-bg').onclick = function(e) {
  if (e.target === this) document.getElementById('intervention-review-modal-bg').classList.remove('active');
};


// ---------- STEP-BY-STEP WIZARD ----------
function openWizard() {
  wizardStep = 0;
  wizardData = {
    challengeTitle: "",
    startDate: new Date().toISOString().slice(0,10),
    goals: [],
    goalDescs: []
  };
  renderWizardStep();
  document.getElementById('wizard-modal-bg').classList.add('active');
}
function closeWizard() {
  document.getElementById('wizard-modal-bg').classList.remove('active');
}
let wizardStep = 0;
let wizardData = {};
const wizardTotalSteps = 12;

function renderWizardStep() {
  const c = wizardData;
  const content = document.getElementById('wizard-content');
  let step = wizardStep;
  content.innerHTML = '';
  function makeInput(label, id, val, type="text", placeholder="", required=true) {
    return `<label style="text-align:left;display:block;font-weight:600;margin-bottom:4px;margin-top:4px;">${label}</label>
    <input class="wizard-input" type="${type}" id="${id}" value="${val||''}" placeholder="${placeholder||''}" ${required?'required':''} autofocus>`;
  }
  function makeTextarea(label, id, val, placeholder="", required=true) {
    return `<label style="text-align:left;display:block;font-weight:600;margin-bottom:4px;margin-top:4px;">${label}</label>
    <textarea class="wizard-textarea" id="${id}" placeholder="${placeholder||''}" ${required?'required':''} autofocus>${val||''}</textarea>`;
  }
  let progressText = '';
  if(step<=11) progressText = `<div class="wizard-progress">Step ${step+1} of 12</div>`;
  if (step === 0) {
    content.innerHTML = `
      ${progressText}
      <div class="wizard-step">
        <h2>What is the name of your challenge?</h2>
        ${makeInput("Challenge Name", "wizTitle", c.challengeTitle||"", "text", "Ex: 90-Day Transformation")}
      </div>
      <div class="wizard-actions">
        <button id="wizNext">Next</button>
      </div>
    `;
    document.getElementById('wizNext').onclick = () => {
      c.challengeTitle = document.getElementById('wizTitle').value.trim() || DEFAULTS.challengeTitle;
      wizardStep++; renderWizardStep();
    };
  } else if (step === 1) {
    content.innerHTML = `
      ${progressText}
      <div class="wizard-step">
        <h2>Pick a start date</h2>
        ${makeInput("Start Date", "wizDate", c.startDate||new Date().toISOString().slice(0,10), "date", "", true)}
      </div>
      <div class="wizard-actions">
        <button id="wizPrev">Back</button>
        <button id="wizNext">Next</button>
      </div>
    `;
    document.getElementById('wizPrev').onclick = () => { wizardStep--; renderWizardStep(); }
    document.getElementById('wizNext').onclick = () => {
      c.startDate = document.getElementById('wizDate').value || new Date().toISOString().slice(0,10);
      wizardStep++; renderWizardStep();
    };
  } else if (step >=2 && step<=11) {
    let goalIdx = Math.floor((step-2)/2);
    let isDesc = ((step-2)%2===1);
    if (!isDesc) {
      content.innerHTML = `
        ${progressText}
        <div class="wizard-step">
          <h2>Goal ${goalIdx+1} Name</h2>
          ${makeInput(`Goal ${goalIdx+1} Name`, `wizGoal${goalIdx}`, c.goals[goalIdx]||"", "text", "E.g. Daily exercise")}
        </div>
        <div class="wizard-actions">
          <button id="wizPrev">Back</button>
          <button id="wizNext">Next</button>
        </div>
      `;
      document.getElementById('wizPrev').onclick = () => { wizardStep--; renderWizardStep(); }
      document.getElementById('wizNext').onclick = () => {
        c.goals[goalIdx] = document.getElementById(`wizGoal${goalIdx}`).value.trim() || DEFAULTS.goals[goalIdx];
        wizardStep++; renderWizardStep();
      };
    } else {
      content.innerHTML = `
        ${progressText}
        <div class="wizard-step">
          <h2>Goal ${goalIdx+1} Description</h2>
          ${makeTextarea(`Goal ${goalIdx+1} Description`, `wizDesc${goalIdx}`, c.goalDescs[goalIdx]||"", "Describe the goal.")}
        </div>
        <div class="wizard-actions">
          <button id="wizPrev">Back</button>
          <button id="wizNext">Next</button>
        </div>
      `;
      document.getElementById('wizPrev').onclick = () => { wizardStep--; renderWizardStep(); }
      document.getElementById('wizNext').onclick = () => {
        c.goalDescs[goalIdx] = document.getElementById(`wizDesc${goalIdx}`).value.trim() || DEFAULTS.goalDescs[goalIdx];
        wizardStep++; renderWizardStep();
      };
    }
  } else if (step === 12) {
    let goalsReview = '';
    for(let i=0;i<5;i++) {
      goalsReview += `<div class="wizard-summary">
        <b>Goal ${i+1}:</b> ${c.goals[i]||DEFAULTS.goals[i]}<br>
        <b>Description:</b> ${c.goalDescs[i]||DEFAULTS.goalDescs[i]}
      </div>`;
    }
    content.innerHTML = `
      <div class="wizard-progress">Step 13 of 13</div>
      <div class="wizard-step">
        <h2>Review & Start</h2>
        <div class="wizard-summary"><b>Challenge Name:</b> ${c.challengeTitle||DEFAULTS.challengeTitle}</div>
        <div class="wizard-summary"><b>Start Date:</b> ${c.startDate||new Date().toISOString().slice(0,10)}</div>
        ${goalsReview}
      </div>
      <div class="wizard-actions">
        <button id="wizPrev">Back</button>
        <button id="wizStart">Start Challenge</button>
      </div>
    `;
    document.getElementById('wizPrev').onclick = () => { wizardStep--; renderWizardStep(); }
    document.getElementById('wizStart').onclick = () => {
      let config = {
        challengeTitle: c.challengeTitle || DEFAULTS.challengeTitle,
        startDate: c.startDate || DEFAULTS.startDate,
        days: 90,
        goals: c.goals.map((g,i)=>g||DEFAULTS.goals[i]),
        goalDescs: c.goalDescs.map((d,i)=>d||DEFAULTS.goalDescs[i])
      };
      let data = getSavedData();
      data.challenge = config;
      data.progress = {};
      data.notes = {};
      data.perfectPlayed = {};
      data.interventions = {};
      saveData(data);
      closeWizard();
      renderTable();
      renderStoplights();
    };
  }
}

// ---- DOM EVENT HOOKS ----
document.addEventListener('DOMContentLoaded', function() {
  renderTable();
  renderStoplights();

  document.getElementById('close-goal-modal').onclick = closeGoalModal;
  document.getElementById('goal-modal-bg').onclick = function(e) {
    if (e.target === this) closeGoalModal();
  };
  document.getElementById('open-wizard-btn').onclick = openWizard;
  document.getElementById('close-wizard-modal').onclick = closeWizard;
  document.getElementById('wizard-modal-bg').onclick = function(e) {
    if (e.target === this) closeWizard();
  };
  window.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      closeGoalModal();
      closeWizard();
      document.getElementById('perfect-days-modal-bg').classList.remove('active');
      closeInterveneWizard();
    }
  });

  // Make header goal names clickable for details modal
  Array.from(document.getElementsByClassName('goal-title-link')).forEach(span => {
    span.onclick = function(e) {
      let goalId = parseInt(this.getAttribute('data-goal-id'));
      openGoalModal(goalId);
    };
  });

  // Wizard opens on first run if no challenge
  const data = getSavedData();
  if (!data.challenge) openWizard();
});

  </script>
</body>
</html>
